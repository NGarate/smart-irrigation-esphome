esphome:
  name: esp32-s3-4plants
  friendly_name: "4 Plants Irrigation Controller"

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: !secret encryption_key

# Enable WiFi for Home Assistant integration
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_pswd
  
  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "ESP32-S3-4Plants"
    password: !secret ap_pswd

captive_portal:

# OTA for updates via WiFi
ota:
  - platform: esphome
    password: !secret ota_pswd

# I2C Bus for ADS1115 ADC module
i2c:
  sda: GPIO8
  scl: GPIO9
  scan: true
  id: bus_a

# ADS1115 ADC module for soil moisture sensors
ads1115:
  - address: 0x48
    i2c_id: bus_a
    id: ads1115_hub

# Calibration values for soil moisture sensors
globals:
  # Plant 1 calibration
  - id: plant1_calibration_dry
    type: float
    restore_value: yes
    initial_value: '3.3'
  - id: plant1_calibration_wet
    type: float
    restore_value: yes
    initial_value: '1.5'

  # Plant 2 calibration
  - id: plant2_calibration_dry
    type: float
    restore_value: yes
    initial_value: '3.3'
  - id: plant2_calibration_wet
    type: float
    restore_value: yes
    initial_value: '1.5'

  # Plant 3 calibration
  - id: plant3_calibration_dry
    type: float
    restore_value: yes
    initial_value: '3.3'
  - id: plant3_calibration_wet
    type: float
    restore_value: yes
    initial_value: '1.5'

  # Plant 4 calibration
  - id: plant4_calibration_dry
    type: float
    restore_value: yes
    initial_value: '3.3'
  - id: plant4_calibration_wet
    type: float
    restore_value: yes
    initial_value: '1.5'

# Water tank level sensor (JSN-SR04T)
sensor:
  # Water tank level sensor
  - platform: ultrasonic
    trigger_pin: GPIO3
    echo_pin: GPI46
    name: "Water Tank Level"
    id: water_tank_level
    unit_of_measurement: "cm"
    accuracy_decimals: 1
    update_interval: 60s
    timeout: 2m
    filters:
      - filter_out: nan
      - median:
          window_size: 5
          send_every: 3
      - lambda: |
          // Convert distance to percentage (assuming 30cm tank height)
          float tank_height = 30.0;
          float level_percentage = ((tank_height - x) / tank_height) * 100.0;
          if (level_percentage > 100.0) return 100.0;
          if (level_percentage < 0.0) return 0.0;
          return level_percentage;
    icon: "mdi:water-percent"

  # Plant 1 Soil Moisture Sensor
  - platform: ads1115
    multiplexer: 'A0_GND'
    gain: 6.144
    name: "Plant 1 Soil Moisture"
    id: plant1_moisture_raw
    unit_of_measurement: "%"
    accuracy_decimals: 1
    update_interval: 30s
    ads1115_id: ads1115_hub
    filters:
      - median:
          window_size: 5
          send_every: 3
      - lambda: |
          // Dynamic calibration using global variables
          float dry_val = id(plant1_calibration_dry);
          float wet_val = id(plant1_calibration_wet);
          float percentage = ((dry_val - x) / (dry_val - wet_val)) * 100.0;
          if (percentage > 100.0) return 100.0;
          if (percentage < 0.0) return 0.0;
          return percentage;
    icon: "mdi:water-percent"

  # Plant 2 Soil Moisture Sensor
  - platform: ads1115
    multiplexer: 'A1_GND'
    gain: 6.144
    name: "Plant 2 Soil Moisture"
    id: plant2_moisture_raw
    unit_of_measurement: "%"
    accuracy_decimals: 1
    update_interval: 30s
    ads1115_id: ads1115_hub
    filters:
      - median:
          window_size: 5
          send_every: 3
      - lambda: |
          float dry_val = id(plant2_calibration_dry);
          float wet_val = id(plant2_calibration_wet);
          float percentage = ((dry_val - x) / (dry_val - wet_val)) * 100.0;
          if (percentage > 100.0) return 100.0;
          if (percentage < 0.0) return 0.0;
          return percentage;
    icon: "mdi:water-percent"

  # Plant 3 Soil Moisture Sensor
  - platform: ads1115
    multiplexer: 'A2_GND'
    gain: 6.144
    name: "Plant 3 Soil Moisture"
    id: plant3_moisture_raw
    unit_of_measurement: "%"
    accuracy_decimals: 1
    update_interval: 30s
    ads1115_id: ads1115_hub
    filters:
      - median:
          window_size: 5
          send_every: 3
      - lambda: |
          float dry_val = id(plant3_calibration_dry);
          float wet_val = id(plant3_calibration_wet);
          float percentage = ((dry_val - x) / (dry_val - wet_val)) * 100.0;
          if (percentage > 100.0) return 100.0;
          if (percentage < 0.0) return 0.0;
          return percentage;
    icon: "mdi:water-percent"

  # Plant 4 Soil Moisture Sensor
  - platform: ads1115
    multiplexer: 'A3_GND'
    gain: 6.144
    name: "Plant 4 Soil Moisture"
    id: plant4_moisture_raw
    unit_of_measurement: "%"
    accuracy_decimals: 1
    update_interval: 30s
    ads1115_id: ads1115_hub
    filters:
      - median:
          window_size: 5
          send_every: 3
      - lambda: |
          float dry_val = id(plant4_calibration_dry);
          float wet_val = id(plant4_calibration_wet);
          float percentage = ((dry_val - x) / (dry_val - wet_val)) * 100.0;
          if (percentage > 100.0) return 100.0;
          if (percentage < 0.0) return 0.0;
          return percentage;
    icon: "mdi:water-percent"

  # System uptime
  - platform: uptime
    name: "System Uptime"
    update_interval: 60s

# Relay control switches for pumps
switch:
  # Plant 1 Pump Relay
  - platform: gpio
    id: plant1_pump_relay
    pin: 
      number: GPIO11
      inverted: true  # Relay modules are typically active LOW
    internal: true  # Hide from HA, use buttons instead

  # Plant 2 Pump Relay
  - platform: gpio
    id: plant2_pump_relay
    pin: 
      number: GPIO12
      inverted: true
    internal: true

  # Plant 3 Pump Relay
  - platform: gpio
    id: plant3_pump_relay
    pin: 
      number: GPIO13
      inverted: true
    internal: true

  # Plant 4 Pump Relay
  - platform: gpio
    id: plant4_pump_relay
    pin: 
      number: GPIO14
      inverted: true
    internal: true

# System restart button
button:
  - platform: restart
    name: "Restart System"

# Binary sensors for status monitoring
binary_sensor:
  # Low water level alert
  - platform: template
    name: "Low Water Level"
    id: low_water_level
    device_class: problem
    lambda: 'return id(water_tank_level).state < 10.0;'

# Number inputs for Home Assistant control
number:
  # Plant 1 Calibration Controls
  - platform: template
    name: "Plant 1 Calibration Dry"
    id: plant1_cal_dry_input
    optimistic: true
    min_value: 0.0
    max_value: 3.3
    step: 0.1
    initial_value: 3.3
    restore_value: true
    unit_of_measurement: "V"
    mode: box
    set_action:
      - globals.set:
          id: plant1_calibration_dry
          value: !lambda 'return x;'

  - platform: template
    name: "Plant 1 Calibration Wet"
    id: plant1_cal_wet_input
    optimistic: true
    min_value: 0.0
    max_value: 3.3
    step: 0.1
    initial_value: 1.5
    restore_value: true
    unit_of_measurement: "V"
    mode: box
    set_action:
      - globals.set:
          id: plant1_calibration_wet
          value: !lambda 'return x;'

  # Plant 2 Calibration Controls
  - platform: template
    name: "Plant 2 Calibration Dry"
    id: plant2_cal_dry_input
    optimistic: true
    min_value: 0.0
    max_value: 3.3
    step: 0.1
    initial_value: 3.3
    restore_value: true
    unit_of_measurement: "V"
    mode: box
    set_action:
      - globals.set:
          id: plant2_calibration_dry
          value: !lambda 'return x;'

  - platform: template
    name: "Plant 2 Calibration Wet"
    id: plant2_cal_wet_input
    optimistic: true
    min_value: 0.0
    max_value: 3.3
    step: 0.1
    initial_value: 1.5
    restore_value: true
    unit_of_measurement: "V"
    mode: box
    set_action:
      - globals.set:
          id: plant2_calibration_wet
          value: !lambda 'return x;'

  # Plant 3 Calibration Controls
  - platform: template
    name: "Plant 3 Calibration Dry"
    id: plant3_cal_dry_input
    optimistic: true
    min_value: 0.0
    max_value: 3.3
    step: 0.1
    initial_value: 3.3
    restore_value: true
    unit_of_measurement: "V"
    mode: box
    set_action:
      - globals.set:
          id: plant3_calibration_dry
          value: !lambda 'return x;'

  - platform: template
    name: "Plant 3 Calibration Wet"
    id: plant3_cal_wet_input
    optimistic: true
    min_value: 0.0
    max_value: 3.3
    step: 0.1
    initial_value: 1.5
    restore_value: true
    unit_of_measurement: "V"
    mode: box
    set_action:
      - globals.set:
          id: plant3_calibration_wet
          value: !lambda 'return x;'

  # Plant 4 Calibration Controls
  - platform: template
    name: "Plant 4 Calibration Dry"
    id: plant4_cal_dry_input
    optimistic: true
    min_value: 0.0
    max_value: 3.3
    step: 0.1
    initial_value: 3.3
    restore_value: true
    unit_of_measurement: "V"
    mode: box
    set_action:
      - globals.set:
          id: plant4_calibration_dry
          value: !lambda 'return x;'

  - platform: template
    name: "Plant 4 Calibration Wet"
    id: plant4_cal_wet_input
    optimistic: true
    min_value: 0.0
    max_value: 3.3
    step: 0.1
    initial_value: 1.5
    restore_value: true
    unit_of_measurement: "V"
    mode: box
    set_action:
      - globals.set:
          id: plant4_calibration_wet
          value: !lambda 'return x;'

# ESPHome Sprinkler Controller for automatic irrigation
sprinkler:
  - id: plant_irrigation_controller
    main_switch: "Irrigation System"
    auto_advance_switch: "Auto Advance"
    valve_open_delay: 2s
    valves:
      - valve_switch: "Plant 1"
        enable_switch: "Enable Plant 1"
        run_duration_number:
          id: plant1_duration_number
          name: "Plant 1 Run Duration"
          initial_value: 30
          min_value: 5
          max_value: 300
          step: 5
          unit_of_measurement: "s"
          mode: box
        valve_switch_id: plant1_pump_relay
      - valve_switch: "Plant 2"
        enable_switch: "Enable Plant 2"
        run_duration_number:
          id: plant2_duration_number
          name: "Plant 2 Run Duration"
          initial_value: 30
          min_value: 5
          max_value: 300
          step: 5
          unit_of_measurement: "s"
          mode: box
        valve_switch_id: plant2_pump_relay
      - valve_switch: "Plant 3"
        enable_switch: "Enable Plant 3"
        run_duration_number:
          id: plant3_duration_number
          name: "Plant 3 Run Duration"
          initial_value: 30
          min_value: 5
          max_value: 300
          step: 5
          unit_of_measurement: "s"
          mode: box
        valve_switch_id: plant3_pump_relay
      - valve_switch: "Plant 4"
        enable_switch: "Enable Plant 4"
        run_duration_number:
          id: plant4_duration_number
          name: "Plant 4 Run Duration"
          initial_value: 30
          min_value: 5
          max_value: 300
          step: 5
          unit_of_measurement: "s"
          mode: box
        valve_switch_id: plant4_pump_relay

# Text sensors for system information
text_sensor:
  - platform: version
    name: "ESPHome Version" 